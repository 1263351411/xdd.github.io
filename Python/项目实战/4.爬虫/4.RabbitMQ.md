# RabbitMQ

* RabbitMQ是由LShift提供的一个Advanced Message Queuing Protocol(AMQP)的开源实现，由以高性能、健壮以及可伸缩性出名的Erlang写成，因此也是继承了这些优点。  

## 安装

* 选择RPM包下载，选择对应平台，本次安装在CentOS7，其他平台类似。[https://www.rabbitmq.com/install-rpm.html](https://www.rabbitmq.com/install-rpm.html)  
* 由于使用了erlang语言开发，所以需要erlang的包。erlang和RabbitMQ的兼容性，参考[https://www.rabbitmq.com/which-erlang.html#compatibility-matrix](https://www.rabbitmq.com/which-erlang.html#compatibility-matrix)

* 下载 rabbitmq-server-3.7.16-1.el7.noarch.rpm、erlang-21.3.8.6-1.el7.x86_64.rpm。socat在CentOS中源中有。  

> yum -y install erlang-21.3.8.6-1.el7.x86_64.rpm rabbitmq-server-3.7.16-1.el7.noarch.rpm  

* 查看安装的文件

````shell
[root@xdd ~]# rpm -ql rabbitmq-server 
/etc/logrotate.d/rabbitmq-server
/etc/profile.d/rabbitmqctl-autocomplete.sh
/etc/rabbitmq
/usr/lib/ocf/resource.d/rabbitmq/rabbitmq-server
/usr/lib/ocf/resource.d/rabbitmq/rabbitmq-server-ha
/usr/lib/rabbitmq/autocomplete/bash_autocomplete.sh
/usr/lib/rabbitmq/autocomplete/zsh_autocomplete.sh
/usr/lib/rabbitmq/bin/cuttlefish
/usr/lib/rabbitmq/bin/rabbitmq-defaults

````

## 配置

* 参考资料[https://www.rabbitmq.com/configure.html#config-location](https://www.rabbitmq.com/configure.html#config-location)

### 环境配置

* 使用系统环境变量，如果没有使用rabbitmq-env.conf中定义环境变量，否则使用缺省值  

````shell
RABBITMQ_NODE_IP_ADDRESS the empty string, meaning that it should bind to all network interfaces.  
RABBITMQ_NODE_PORT 5672  
RABBITMQ_DIST_PORT RABBITMQ_NODE_PORT + 20000  #内部节点和客户端工具通信用  
RABBITMQ_CONFIG_FILE 配置文件路径默认为/etc/rabbitmq/rabbitmq  
````  

环境变量文件，可以不配置  

### 工作特性配置文件

* rabbitmq.config配置文件
* 3.7支持新旧两种配置文件格式

1. erlang配置文件格式，为了兼容继续采用

    ![rabbitmq_001](../../../img/python/rabbitmq_001.png)

2. sysctl格式，如果不需要兼容，RabbitMQ鼓励使用。  (这个文件也可以不配置)
    ![rabbitmq_002](../../../img/python/rabbitmq_002.png)

### 插件管理

列出所有可用插件  

> rabbitmq-plugins list

* 启动WEB管理插件，会依赖启用其他几个插件。

````shell
[root@xdd rabbitmq]$ rabbitmq-plugins enable rabbitmq_management
````

### 启动服务

> systemctl start rabbitmq-server  

* 启动中，可能出现下面的错误
    1. `Error when reading /var/lib/rabbitmq/.erlang.cookie:eacces`这就是这个文件的权限问题，修改属组、属组为rabbitmq即可
    `chown rabbitmq.rabbitmq /var/lib/rabbitmq/.erlang.cookie: eacces`
* 服务启动成功

````shell
[root@xdd ~]# ss -tanl | grep 5672
LISTEN     0      128          *:25672                    *:*
LISTEN     0      128          *:15672                    *:*
LISTEN     0      128         :::5672                    :::*
[root@xdd ~]#
````

### 用户管理

* 开始登陆WEB界面,`http://192.168.61.109(rabbitmq所在主机的ip):15672`  
    ![rabbitmq_003](../../../img/python/rabbitmq_003.png)
* 使用guest/guest只能本地登陆，远程登录会报错

1. rabbitmqctl命令
    * `rabbitmqctl [-n <node>] [-1][-q] <command> [<command options>]`
    * General options:
        1. `-n` node
        2. `-q`,--quiet
        3. `-t`,--timeout timeout
        4. `-l` longnames
    * Commands:
        1. `add_user <username> <password>` 添加用户
        2. `list_user`    列出用户
        3. `delete_user username` 删除用户


























